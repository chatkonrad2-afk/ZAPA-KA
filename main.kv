#:import sp kivy.metrics.sp
#:import SlideTransition kivy.uix.screenmanager.SlideTransition
<FlagButton@ButtonBehavior+Image>:
    size_hint: None, None
    size: "36dp", "24dp"      # ma≈Ça flaga; zmie≈Ñ np. na 48x32dp, je≈õli chcesz wiƒôkszƒÖ
    allow_stretch: True
    keep_ratio: True
<ChatBubble@MDCard>:
    text: ""
    halign: "left"
    size_hint_x: None
    size_hint_y: None
    padding: dp(10)
    radius: [15, 15, 15, 15]
    md_bg_color: (0.20, 0.45, 0.75, 0.3) if root.halign == "right" else (0.3, 0.3, 0.3, 0.3)
    width: min(self.ids.lbl.texture_size[0] + dp(70), dp(340))
    height: self.ids.lbl.texture_size[1] + dp(20)
    pos_hint: {"right": 1} if root.halign == "right" else {"x": 0}   # üî• to przesuwa

    MDLabel:
        id: lbl
        text: root.text
        halign: root.halign
        theme_text_color: "Custom"
        text_color: 1, 1, 1, 1
        text_size: (dp(350), None)
        size_hint_y: None
        height: self.texture_size[1]


MDScreenManager:
    LoginScreen:
    RegisterScreen:
    MainScreen:
    ChatScreen:

<LoginScreen>:
    name: "login"
    Image:
        source: "pic.png"
        allow_stretch: True
        keep_ratio: False
        size_hint: None, None
        size: "360dp", "640dp"
        pos_hint: {"center_x": .5, "center_y": .5}

    MDLabel:
        text: "ZAPA≈ÅKA"
        halign: "center"
        font_size: "48sp"
        theme_text_color: "Custom"
        text_color: 1, 1, 1, 1   # ~ #FF5623
        pos_hint: {"center_y": .8}

    MDLabel:
        text: "\nPolski Telegram\n Mo≈ºliwo≈õƒá Kupna VIP\n Stawiamy na bezpiecze≈Ñstwo waszych czat√≥w!"
        halign: "center"
        font_size: "14sp"
        size_hint_x: .85
        pos_hint: {"center_x": .5, "center_y": .62}
        text_color: 1, 1, 1, 1
        write_tab: False

    MDLabel:
        text: "Ekran Logowania"
        halign: "left"
        font_size: "21sp"
        size_hint_x: .85
        pos_hint: {"center_x": .5, "center_y": .49}
        text_color: 1, 1, 1, 1
        write_tab: False

    MDTextField:
        id: login_user
        hint_text: "Nazwa u≈ºytkownika"
        halign: "left"            # ‚Üê albo usu≈Ñ tƒô liniƒô
        icon_right: "account"
        font_size: "20sp"
        size_hint_x: .85
        pos_hint: {"center_x": .5, "center_y": .39}
        on_text: self.text = self.text.replace(" ", "")
        write_tab: False

    MDTextField:
        id: login_pass
        hint_text: "Has≈Ço"
        password: True
        icon_right: "eye-off"
        font_size: "20sp"
        size_hint_x: .85
        pos_hint: {"center_x": .5, "center_y": .31}
        on_text: self.text = self.text.replace(" ", "")
        write_tab: False


    MDLabel:
        text: "[ref=toggle]Poka≈º has≈Ço[/ref]"
        pos_hint: {"center_x": 1.144, "center_y": .242}
        font_size: "13sp"
        markup: True
        theme_text_color: "Custom"
        text_color: (1, 0.431, 0.165, 1) if cb.active else (1, 1, 1, .7)
        on_ref_press:
            cb.active = not cb.active

    MDCheckbox:
        id: cb
        size_hint: None, None
        pos_hint: {"center_x": .87, "center_y": .24}
        size: "50dp", "50dp"
        on_active:
            login_pass.password = not self.active
            login_pass.icon_right = "eye" if self.active else "eye-off"

    MDBoxLayout:
        size_hint: .85, None
        height: "25dp"
        pos_hint: {"center_x": .515, "center_y": .15}
        spacing: "30dp"

        MDRaisedButton:
            text: "Zaloguj siƒô"
            font_size: "18sp"
            on_press: app.login()
            md_bg_color: 0.89, 0.78, 0.63, 1      # #FFB300
            theme_text_color: "Custom"
            text_color: 0.02, 0.30, 0.30, 1     # #0E1B3D (granat z t≈Ça)
            ripple_color: 0, 0, 0, 0

        MDRaisedButton:
            text: "Nowa Zapa≈Çka"
            font_size: "18sp"
            on_press:
                root.manager.transition = SlideTransition(direction='up', duration=0.8)
                root.manager.current = 'register'
            md_bg_color: 0.70, 0.32, 0.15, 1  # #F4511E
            theme_text_color: "Custom"
            text_color: 1, 1, 1, 1              # bia≈Çy
            ripple_color: 0, 0, 0, 0

    AnchorLayout:
        anchor_x: "right"
        anchor_y: "bottom"
        padding: "13dp"       # margines od krawƒôdzi

        FlagButton:
            source: "pl.png"  # ‚Üê wstaw sw√≥j plik PNG z flagƒÖ
            on_release: app.set_language("pl")

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "bottom"
        padding: "0dp"

        MDIconButton:
            icon: "copyright"
            theme_text_color: "Custom"
            text_color: 0.89, 0.78, 0.63, 1
            on_release: app.open_copyright()

        AnchorLayout:
            anchor_x: "left"
            anchor_y: "bottom"
            padding: "8dp"

            MDFillRoundFlatIconButton:
                id: id_key_register
                icon: "key-variant"
                text: "ID"
                size_hint: None, None
                on_release: app.go_main()

<RegisterScreen>:
    name: "register"
    Image:
        source: "pic.png"
        allow_stretch: True
        keep_ratio: False
        size_hint: None, None
        size: "360dp", "640dp"
        pos_hint: {"center_x": .5, "center_y": .5}

    MDLabel:
        text: "ZAPA≈ÅKA"
        halign: "center"
        font_size: "68sp"
        theme_text_color: "Custom"
        text_color: 1, 1, 1, 1   # ~ #FF5623
        pos_hint: {"center_y": .8}

    MDLabel:
        text: "Ekran Odpalania Zapa≈Çki"
        halign: "center"
        font_size: "21sp"
        size_hint_x: .85
        pos_hint: {"center_x": .5, "center_y": .60}
        text_color: 1, 1, 1, 1
        write_tab: False

    MDTextField:
        id: reg_user
        hint_text: "Nazwa u≈ºytkownika"
        icon_right: "account"
        font_size: "20sp"
        size_hint_x: .85
        pos_hint: {"center_x": .5, "center_y": .50}
        on_text: self.text = self.text.replace(" ", "")
        write_tab: False

    MDTextField:
        id: reg_email
        hint_text: "Adres E-Mail"
        icon_right: "email-outline"
        font_size: "20sp"
        size_hint_x: .85
        pos_hint: {"center_x": .5, "center_y": .42}
        on_text: self.text = self.text.replace(" ", "")
        write_tab: False

    MDTextField:
        id: reg_pass
        hint_text: "Has≈Ço"
        password: True
        icon_right: "eye-off"
        font_size: "20sp"
        size_hint_x: .85
        pos_hint: {"center_x": .5, "center_y": .34}
        on_text: self.text = self.text.replace(" ", "")
        write_tab: False

    MDLabel:
        text: "[ref=toggle]Poka≈º has≈Ço[/ref]"
        pos_hint: {"center_x": 1.144, "center_y": .272}
        font_size: "13sp"
        markup: True
        theme_text_color: "Custom"
        text_color: (1, 0.431, 0.165, 1) if cb.active else (1, 1, 1, .7)
        on_ref_press:
            cb.active = not cb.active

    MDCheckbox:
        id: cb
        size_hint: None, None
        pos_hint: {"center_x": .87, "center_y": .270}
        size: "50dp", "50dp"
        on_active:
            reg_pass.password = not self.active
            reg_pass.icon_right = "eye" if self.active else "eye-off"

    MDBoxLayout:
        size_hint: .55, None
        height: "20dp"
        pos_hint: {"center_x": 0.815, "center_y": .1}
        spacing: "0dp"
        MDIconButton:
            icon: "google"
            user_font_size: "24sp"
            theme_text_color: "Primary"
            on_release: app.google_sign_in()
            line_color: 1, 1, 1, .6
        MDLabel:
            text: "[ref=toggle]Rejestracja przez\nGoogle[/ref]"
            pos_hint: {"center_x": 0, "center_y": 1.1}
            font_size: "12sp"
            markup: True
            theme_text_color: "Custom"
            text_color: 0.2588, 0.5216, 0.9569,

    MDBoxLayout:
        size_hint: 1, None
        height: "25dp"
        pos_hint: {"center_x": 0.54, "center_y": .18}
        spacing: "10dp"
        MDRectangleFlatIconButton:
            icon: "arrow-left"
            text: "Wr√≥ƒá do Logowania"
            theme_text_color: "Custom"
            text_color: 1, 1, 1, 1
            line_color: 1, 1, 1, .6
            on_release:
                root.manager.transition = SlideTransition(direction='right', duration=.25)
                root.manager.current = "login"
        MDRaisedButton:
            text: "Utw√≥rz Konto"
            font_size: "17.5sp"
            on_release: app.register_account()
            md_bg_color: app.theme_cls.primary_color
            theme_text_color: "Custom"
            text_color: 1, 1, 1, 1            # bia≈Çy
            ripple_color: 0, 0, 0, 0

    AnchorLayout:
        anchor_x: "right"
        anchor_y: "bottom"
        padding: "13dp"       # margines od krawƒôdzi

        FlagButton:
            source: "pl.png"  # ‚Üê wstaw sw√≥j plik PNG z flagƒÖ
            on_release: app.set_language("pl")

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "bottom"
        padding: "0dp"

        MDIconButton:
            icon: "copyright"
            theme_text_color: "Custom"
            text_color: 0.89, 0.78, 0.63, 1
            on_release: app.open_copyright()

    AnchorLayout:
        anchor_x: "left"
        anchor_y: "bottom"
        padding: "8dp"

        MDFillRoundFlatIconButton:
            id: id_key_register
            icon: "key-variant"
            text: "ID"

<MainScreen>:
    name: "main"

    MDBottomNavigation:
        size_hint: 1, 1
        panel_color: 0.05, 0.11, 0.24, 0.01   # granatowy, alfa=0.6
        text_color_active: 1, 1, 1, 1
        text_color_normal: 0.7, 0.7, 0.7, 1
        selected_color_background: 0.96, 0.27, 0.12, 1

        # --- HOME ---
        MDBottomNavigationItem:
            name: "screen_home"
            text: "Home"
            icon: "home"

            FloatLayout:
                Image:
                    source: "main.png"
                    allow_stretch: True
                    keep_ratio: False
                    size_hint: 1, 1

                MDLabel:
                    text: "Witaj " + app.username + " !"
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1

        # --- CHAT ---
        MDBottomNavigationItem:
            name: "screen_chat"
            text: "Czaty"
            icon: "chat"
            on_tab_press: app.load_private_chats()

            FloatLayout:
                Image:
                    source: "main4.png"
                    allow_stretch: True
                    keep_ratio: False
                    size_hint: 1, 1

            BoxLayout:
                orientation: "vertical"
                padding: "12dp"
                spacing: "12dp"

                MDLabel:
                    text: "Twoje czaty (odswie≈º)"
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1
                    font_style: "H6"
                    size_hint_y: None
                    height: self.texture_size[1] + dp(20)

                ScrollView:
                    MDList:
                        id: private_chats   # czaty od samej g√≥ry

                MDRaisedButton:
                    text: "Od≈õwie≈º czaty"
                    size_hint_y: None
                    height: "48dp"
                    pos_hint: {"center_x": .5}
                    on_release: app.load_private_chats()
                    md_bg_color: 0.96, 0.27, 0.12, 1   # kontrastowy kolor
                    text_color: 1, 1, 1, 1
                    ripple_color: 0, 0, 0, 0

        # --- FRIENDS / SEARCH ---
        MDBottomNavigationItem:
            name: "screen_search"
            text: "Szukaj"
            icon: "magnify"

            FloatLayout:
                Image:
                    source: "main1.png"
                    allow_stretch: True
                    keep_ratio: False
                    size_hint: 1, 1

                BoxLayout:
                    orientation: "vertical"
                    spacing: "12dp"
                    padding: "12dp"

                    MDTextField:
                        id: search_field
                        hint_text: "Wpisz nazwƒô u≈ºytkownika"
                        on_text_validate: app.search_friend(self.text)

                    MDRaisedButton:
                        text: "Szukaj"
                        pos_hint: {"center_x": .5}
                        on_release: app.search_friend(search_field.text)

                    ScrollView:
                        MDList:
                            id: search_results

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(60)

    # Cie≈Ñ / Glow (trochƒô wiƒôkszy, p√≥≈Çprzezroczysty)
                        MDLabel:
                            text: "\n \n \n OczekujƒÖce zaproszenia"
                            halign: "center"
                            font_size: "24sp"
                            theme_text_color: "Custom"
                            text_color: 0.96, 0.27, 0.12, 0.3   # ten sam pomara≈Ñczowy, ale p√≥≈Çprzezroczysty
                            pos_hint: {"center_x": .5, "center_y": .45}  # minimalnie ni≈ºej dla efektu cienia

    # W≈Ça≈õciwy napis (na wierzchu)
                        MDLabel:
                            text: "\n \n \n OczekujƒÖce zaproszenia"
                            halign: "center"
                            font_size: "22sp"
                            theme_text_color: "Custom"
                            text_color: 0.96, 0.27, 0.12, 1   # g≈Ç√≥wny, pe≈Çny pomara≈Ñczowy
                            pos_hint: {"center_x": .5, "center_y": .5}

                    ScrollView:
                        MDList:
                            id: friend_requests

                    MDRaisedButton:
                        text: "Od≈õwie≈º zaproszenia"
                        pos_hint: {"center_x": .5}
                        on_release: app.load_friend_requests()

        # --- SETTINGS ---
        MDBottomNavigationItem:
            name: "screen_settings"
            text: "Ustawienia"
            icon: "cog"

            FloatLayout:
                Image:
                    source: "main3.png"
                    allow_stretch: True
                    keep_ratio: False
                    size_hint: 1, 1

                MDLabel:
                    text: "Panel ustawie≈Ñ"
                    halign: "center"
                    theme_text_color: "Custom"
                    text_color: 1, 1, 1, 1



<ChatScreen>
    name: "chat"
    on_enter: app.start_chat_polling()
    on_leave: app.stop_chat_polling()

    FloatLayout:
        Image:
            source: "main2.png"
            allow_stretch: True
            keep_ratio: False
            size_hint: 1, 1

        MDBoxLayout:
            orientation: "vertical"

            MDTopAppBar:
                id: topbar
                title: "Czat"
                elevation: 0
                md_bg_color: 0.96, 0.27, 0.12, 1   # ten sam co przycisk
                specific_text_color: 1, 1, 1, 1
                left_action_items: [["arrow-left", lambda x: app.go_main()]]

            RecycleView:
                id: rv
                viewclass: "ChatBubble"
                bar_width: "4dp"
                scroll_wheel_distance: "80dp"

                RecycleBoxLayout:
                    default_size: None, None   # üî• wa≈ºne: niech ka≈ºdy element sam ustala szer./wys.
                    default_size_hint: None, None
                    size_hint_y: None
                    height: self.minimum_height
                    orientation: "vertical"
                    spacing: dp(10)
                    padding: dp(10)


            MDTextField:
                id: msg_input
                pos_hint: {"center_x": .5}
                size_hint_x: .9
                hint_text: "Napisz wiadomo≈õƒá‚Ä¶"
                icon_right: "send"
                on_text_validate:
                    app.send_message(self.text)
                    self.text = ""
                on_icon_right:
                    app.send_message(self.text)
                    self.text = ""
